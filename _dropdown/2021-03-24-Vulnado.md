---
layout: page
title: "Vulnado"
description: "Vulnado"
dropdown: CTF
priority: 1
---

‚ÄúVulnado, Ownado? WTF!?"
<!--more-->

## O que √©?
Seguindo a pr√≥pria explica√ß√£o do github do projeto:<br>√â uma aplica√ß√£o vulner√°vel feita em Java, que cont√©m algumas das vulnerabilidades do OWASP TOP 10. --> Github [Vulnado](https://github.com/ScaleSec/vulnado).<br>

<div class="alert alert-success" role="alert">
Neste post irei explorar e explicar a falhas dessa aplica√ß√£o a n√≠vel de c√≥digo!
</div>

## Aplica√ß√£o

Essa √© a p√°gina inicial da aplica√ß√£o, assim que inicializamos o docker.
<br>
<img src="/assets/img/Vulnado-1.png">
<br>
No pr√≥prio github da aplica√ß√£o, existem os desafios e suas respectivas resolu√ß√µes. Por√©m a n√≠vel de aplica√ß√£o e como disse aqui vamos olhar linha a linha. ü•≤<br>

* Os desafios s√£o os seguintes:
    * SQLi
    * XSS
    * SSRF
    * RCE

## SQLi

Essa aplica√ß√£o possui uma falha de SQLi no login, abaixo temos um trecho do c√≥digo da aplica√ß√£o que concatena uma vari√°vel que √© controlada pelo usu√°rio diretamente na query SQL.

##### User.java
```java 
public static User fetch(String un) {
Statement stmt = null;
User user = null;
try {
    Connection cxn = Postgres.connection();
    stmt = cxn.createStatement();
    System.out.println("Opened database successfully");

    String query = "select * from users where username = '" + un + "' limit 1";
    System.out.println(query);
    ResultSet rs = stmt.executeQuery(query);
    if (rs.next()) {
    String user_id = rs.getString("user_id");
    String username = rs.getString("username");
    String password = rs.getString("password");
    user = new User(user_id, username, password);
    }
```

Se prestarmos aten√ß√£o na linha que o SELECT √© feito conseguimos perceber nitidamente que a vari√°vel `un` vem do argumento do m√©todo **User fetch** que √© o nome do usu√°rio.<br>

Ent√£o se utilizarmos o comando `admin' OR 1=1 --`, vamos conseguir bypassar o login? 

### SQN!!
<br>
<img src="https://i.pinimg.com/originals/65/12/c6/6512c69ff133bbcef78105532712b8f1.gif">
<br>

Essa aplica√ß√£o foi construida "propositalmente", para n√£o realizar o seu login, mesmo que seu payload esteja correto!. Exemplo:<br>
<br>
<img src="/assets/img/Vulnado-2.png">
<br>
Nessa imagem vemos que a conex√£o com o Banco de dados √© realizada com sucesso, por√©m n√£o conseguimos logar como admin. O que podemos fazer ent√£o para ter uma prova de conceito real de que nosso payload est√° funcionando? **Sleep 4ever!!**.<br>

Sou da seguinte opni√£o que todo payload para realizar PoC de SQLi deveria ter uma fun√ß√£o sleep, mesmo que n√£o seja blind, pois ir√° funcionar em ambos os casos..

Executando o seguinte payload: `'; select pg_sleep(10) --`, conseguimos ter certeza de que nossos comando SQL est√£o funcionando...<br>

##### LoginController.java
```java
  @CrossOrigin(origins = "*")
  @RequestMapping(value = "/login", method = RequestMethod.POST, produces = "application/json", consumes = "application/json")
  LoginResponse login(@RequestBody LoginRequest input) {
    User user = User.fetch(input.username);
    if (Postgres.md5(input.password).equals(user.hashedPassword)) {
      return new LoginResponse(user.token(secret));
    } else {
      throw new Unauthorized("Access Denied");
    }
```
Continuando nossa Saga, iremos analisar um segundo trecho de c√≥digo que nos diz o seguinte:<br>
O Postgres compara o MD5 da senha inputada pelo usu√°rio com a hash que existe no Banco da dados. (~~N√£o vou nem entrar no m√©rito do **MD5** ser uma hash ultrapassada~~)

Mas com as informa√ß√µes do primeiro trecho de c√≥digo que faz um **select na tabela users** e com o segundo trecho **que mostra como realiza o md5 da senha**, podemos tentar alterar a senha do usu√°rio admin e logo em seguida logar com as novas credenciais..

Agora nosso payload fica algo mais ou menos assim:<br> 
`'; update users set password=md5('parad0x_0xff') where username = 'admin' --`<br>

No meu caso se eu tentar logar **"admin:para0x_0xff"**, vai funcionar, porque uma vez que a query SQL foi quebrada atrav√©s das aspas simples e o comando de update de senha foi interpretado pelo DB. Mesmo que cause um erro na aplica√ß√£o o comando j√° vai ter sido executado.

>Agora, espero que voc√™ tenha conseguido entender a n√≠vel de c√≥digo o que aconteceu para existir a vulnerabilidade e como explora-la.

## Misconfiguration

Uma vez que analisamos o c√≥digo √© poss√≠vel encontrar usu√°rio e senha chumbados no c√≥digo.

##### Postgres.java
```java
            // Insert seed data
            insertUser("admin", "!!SuperSecretAdmin!!");
            insertUser("alice", "AlicePassword!");
            insertUser("bob", "BobPassword!");
            insertUser("eve", "$EVELknev^l");
            insertUser("rick", "!GetSchwifty!");
```
>Al√©m de vulnerabilidades, quando estamos realizando um code review, deve-se buscar por fragilidades tamb√©m. 

[Parte 2](../blog/2021/03/28/Vulnado2.html)
